<!DOCTYPE html>
<html>
<head>
	<title></title>


	<style type="text/css">

	  body {
      font-family: 'Open Sans', sans-serif;
      margin: auto;
      position: relative;

    }

    svg {
      background: #FFF;
    }

    form {
      position: absolute;
      right: 10px;
      top: 10px;
    }

    .legendItem {
      fill: #fff;
      font-size: 13px;
    }

    text {
      text-anchor: middle;
      fill: #666;
    }

    tspan {
      max-width: 200px;
      display: block;
    }

	  

	</style>

</head>
<body>

   
  <script src="http://d3js.org/d3.v3.min.js"></script>

  <script>

    const parseRoot = (wirkstoffe) => {
      
      const parsedObject = {
      	"name": "ATC",
        'description': 'Klassifikation'
      }

      const atcs = Object.keys(wirkstoffe)

      parsedObject.children = atcs.reduce((acc, atc) => {

        switch (atc.length) {

          case 1: 
            acc[atc] = { "name" : atc, description: wirkstoffe[atc], description: wirkstoffe[atc], "children" : {} }
          break
          case 3:
            acc[atc.substr(0, 1)].children[atc] = { "name" : atc, description: wirkstoffe[atc], "children" : {} }
          break
          case 4: 
            
            try {
              acc[atc.substr(0, 1)].children[atc.substr(0, 3)].children[atc] = { "name" : atc, description: wirkstoffe[atc], "children" : {} }
            } catch (err) {
              console.log(err)
            }

          break
          case 5:

            try {
              acc[atc.substr(0, 1)].children[atc.substr(0, 3)].children[atc.substr(0, 4)].children[atc] = { "name" : atc, description: wirkstoffe[atc], "children" : {} }
            } catch (err) {
            	console.log(err)
            }
          break
          case 7:

            try {
              acc[atc.substr(0, 1)].children[atc.substr(0, 3)].children[atc.substr(0, 4)].children[atc.substr(0, 5)].children[atc] = { "name" : atc, description: wirkstoffe[atc], "children" : {} }
            } catch (err) {
            	console.log(err)
            }

          break
        }

        return acc
       
      }, {})

      const convertToArray = (children) => {

      	Object.values(children).forEach((atc) => {

            if(Object.values(atc.children).length) {
              convertToArray(atc.children)
              atc.children = Object.values(atc.children)
            } else {
              delete atc.children
            }
      	}) 
      }

      parsedObject.children = Object.values(parsedObject.children)

      convertToArray(parsedObject.children)

      return parsedObject
    }


    var width = 700,
        height = 740,
        radius = Math.min(width, height) / 2,
        colors = {'A': '#583093', 'B': '#22409a', 'C': '#0465b2', 'D': '#00acac', 'G': '#04a45e', 'H': '#6fbf43', 'J': '#fef101', 'L': '#f8a51c', 'M': '#f58225', 'N': '#ed3f3d', 'P': '#ee1c25', 'R': '#b81118', 'S': '#008989', 'V': '#cbbe03'},
        colorOpacity = 0.7;

    var svg = d3.select("body").append("svg")
        .attr("width", '100%')
        .attr("height", height);

    var vis = svg.append("g")
      .attr("transform", "translate(" + width / 1.8 + "," + height / 2 + ") scale(1.05)")
      .call(d3.behavior.zoom().scaleExtent([1, 12]).on("zoom", zoom))
      .append("g");

    function zoom() {
      vis.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

    var partition = d3.layout.partition()
      .size([2 * Math.PI, radius * radius])
      .value(function(d) { return d.size; });

    var arc = d3.svg.arc()
      .startAngle(function(d) { return d.x; })
      .endAngle(function(d) { return d.x + d.dx; })
      .innerRadius(function(d) { return Math.sqrt(d.y); })
      .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

    var text = vis.append("text")
      .attr("x", 0)
      .attr("y", 0)
      .attr("dy", "0.35em")

    var getColor = function(d) {
      const atcStart = d.name.substr(0, 1)
      if (d.name === "ATC") {
        return '#7E7F7E';
      } else  {
        return colors[atcStart];
      } 
    };

    var setSize = function(d) {
      if (!d.hasOwnProperty("children")) {
        d.size = 1;
        return 1;
      } else {
        var sum = 1;

        d.children.forEach(function(c) {
          sum += setSize(c);
        });

        d.size = sum;
        return d.size;
      }

      return d;
    };

    function wrap(text, width) {

      text.each(function () {
        var text = d3.select(this),
          words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1,
          x = text.attr("x"),
          y = text.attr("y"),
          dy = 0,
          tspan = text.text(null)
                      .append("tspan")
                      

        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
              ++lineNumber
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = text.append("tspan")
                          .attr("x", x)
                          .attr("y", y)
                          .attr("dy", '1.1em')
                          .text(word);
          }
        }
      });
    }

    drawLegend();

    d3.json("/data/wirkstoffe.json", function(error, root) {


      const wirkstoffe = parseRoot(root)
      
      setSize(wirkstoffe);

      root = {"name": wirkstoffe.name, "size": wirkstoffe.size, "children": [wirkstoffe]};
      
      var path = vis.datum(root).selectAll("path")
          .data(partition.nodes)
        .enter().append("path")
          .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
          .attr("d", arc)
          .style("stroke", "#fff")
          .style("fill", function(d) { return getColor(d); })
          .style("opacity", colorOpacity)
          .on("mouseover", mouseover)
          .on("mouseout", mouseout);

      //<tspan style='font-size: 30px' x=0 dy='35'>" + percentage + "%</tspan>

      const displaySize = (size) => {
        if(size > 1) {
          return "</tspan><tspan  x=0 dy='30' style='font-size: 15px'>" +  size + " Wirkstoffe </tspan>"
        }
      }
      
      function mouseover(d) {
        //var percentage = (100 * d.size / root.size).toPrecision(3);
        text.html("<tspan style='font-size: 30px' x=0 dy='-20'>" + d.name + "</tspan><tspan style='font-size: 17px' x=0 dy='30'>" + d.description + displaySize(d.size));
        
        d3.selectAll("path")
          .filter(function(d1) { return d === d1; })
          .style("opacity", 0.5);

        const tspans = d3.selectAll('tspan')
          .call(wrap, 200)

      }
      
      function mouseout(d) {
        text.html("");
        
        d3.selectAll("path")
          .filter(function(d1) { return d === d1; })
          .style("opacity", colorOpacity);
      }
      
    });

    d3.select(self.frameElement).style("height", height + "px");

    function drawLegend() {
      var li = {
        w: 85, h: 30, s: 3, r: 3
      };

      var legend = svg.append("g")
          .attr("transform", function(d, i) {
            return "translate(" + (width - li.w*-0.8) + "," + (height - li.h*Object.keys(colors).length*1.4) + ")";
          });

      var g = legend.selectAll("g")
          .data(d3.entries(colors))
          .enter().append("svg:g")
          .attr("transform", function(d, i) {
                  return "translate(0," + (i * (li.h + li.s)) + ")";
               });

      g.append("svg:rect")
          .attr("rx", li.r)
          .attr("ry", li.r)
          .attr("width", li.w)
          .attr("height", li.h)
          .style("opacity", colorOpacity)  
          .style("fill", function(d) { return d.value; });

      g.append("svg:text")
          .attr("x", li.w / 2)
          .attr("y", li.h / 2)
          .attr("dy", "0.35em")
          .attr("text-anchor", "middle")
          .attr('textLength', '200px')
          .style('max-width', '200px')
          .style('display', 'block')
          .style('overflow', 'hidden')
          .classed("legendItem", true)
          .text(function(d) { return d.key; });

    }

  </script>

</body>
</html>